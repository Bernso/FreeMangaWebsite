<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ manga_name }} - {{ chapter_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='mangaStyle.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='fav.png') }}" type="image/png">
</head>
<body>
    {% include 'header.html' %}

    <div class="side-menu uncopyable" class='uncopyable'>
        <div class='general'>
            <div class='manga-informaion'>
                <h2 class="manga-title">{{ manga_name }}</h2>
                <p>{{ chapter_name }}</p>
            </div>

            <div class="controls">
                <label for="image-height">Adjust Height:</label>
                <input type="range" id="image-height" min="1" class="uncopyable">
                <label id="height-value">&nbsp;&nbsp;{{ saved_height }}px</label>
            </div>

            <div class="current-page">
                <button id="prev-panel" class="arrow-btn">←</button>
                <p id="current-page-display">1 / {{ images|length }}</p>
                <button id="next-panel" class="arrow-btn">→</button>
            </div>
            <div class="chapter-navigation">
                {% if previous_chapter %}
                    <a href="{{ url_for('manga_reader', manga_name=manga_name, chapter_name=previous_chapter) }}" class="btn">Previous Chapter</a>
                {% endif %}
                {% if next_chapter %}
                    <a href="{{ url_for('manga_reader', manga_name=manga_name, chapter_name=next_chapter) }}" class="btn">Next Chapter</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container">
        <div class="manga-viewer unselectable">
            <img id="manga-panel" src="{{ images[0] }}" alt="Manga Panel">
        </div>
    </div>

    <div class="progress-container">
        <div id="progress-bar"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const images = {{ images|tojson }};
            let currentImageIndex = 0;
        
            const mangaPanel = document.getElementById('manga-panel');
            const heightSlider = document.getElementById('image-height');
            const heightValueLabel = document.getElementById('height-value');
            const progressBar = document.getElementById('progress-bar');
            const prevChapterLink = document.querySelector('.chapter-navigation a:first-child');
            const nextChapterLink = document.querySelector('.chapter-navigation a:last-child');
            const currentPageDisplay = document.getElementById('current-page-display');
            const prevPanelButton = document.getElementById('prev-panel');
            const nextPanelButton = document.getElementById('next-panel');
            const container = document.querySelector('.container');
        
            // Preload images to reduce lag
            function preloadImages(imageArray) {
                imageArray.forEach((imageSrc) => {
                    const img = new Image();
                    img.onload = () => console.log(`Preloaded image: ${imageSrc}`);
                    img.src = imageSrc;
                });
            }
        
            preloadImages(images);
        
            const viewportHeight = window.innerHeight;
            heightSlider.max = viewportHeight;
        
            const savedHeight = localStorage.getItem('mangaPanelHeight') || '500';
            heightSlider.value = savedHeight;
            mangaPanel.style.height = savedHeight + 'px';
            heightValueLabel.textContent = `${savedHeight}px`;
        
            function updateProgressBar() {
                const progress = ((currentImageIndex + 1) / images.length) * 100;
                progressBar.style.width = progress + '%';
            }
        
            function updateImage() {
                if (images.length > 0) {
                    mangaPanel.src = images[currentImageIndex];
                    updateProgressBar();
                    updateCurrentPageDisplay();
                }
            }
        
            function updateCurrentPageDisplay() {
                currentPageDisplay.textContent = `${currentImageIndex + 1} / ${images.length}`;
            }
        
            function adjustHeight() {
                const newHeight = heightSlider.value;
                mangaPanel.style.height = newHeight + 'px';
                heightValueLabel.textContent = `${newHeight}px`;
                localStorage.setItem('mangaPanelHeight', newHeight);
        
                fetch('/save_height', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ height: newHeight })
                });
            }
        
            function goToPreviousPanel() {
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    updateImage();
                } else if (currentImageIndex === 0 && prevChapterLink) {
                    window.location.href = prevChapterLink.href;
                }
            }
        
            function goToNextPanel() {
                if (currentImageIndex < images.length - 1) {
                    currentImageIndex++;
                    updateImage();
                } else if (currentImageIndex === images.length - 1 && nextChapterLink) {
                    window.location.href = nextChapterLink.href;
                }
            }
        
            // Keyboard navigation
            document.addEventListener('keydown', function(event) {
                if (event.key === 'ArrowLeft') {
                    goToPreviousPanel();
                } else if (event.key === 'ArrowRight') {
                    goToNextPanel();
                }
            });
        
            // Arrow button navigation
            prevPanelButton.addEventListener('click', goToPreviousPanel);
            nextPanelButton.addEventListener('click', goToNextPanel);
        
            // Height adjustment
            heightSlider.addEventListener('input', adjustHeight);
        
            // Click navigation on the container
            container.addEventListener('click', function(event) {
                const containerRect = container.getBoundingClientRect();
                const clickPosition = event.clientX - containerRect.left;
                const containerWidth = containerRect.width;

                if (clickPosition < containerWidth / 2) {
                    goToPreviousPanel();
                } else {
                    goToNextPanel();
                }
            });
        
            // Initial setup
            adjustHeight();
            updateImage();
        });
        
        // Hide and show the header with 'h' key
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.main-header');
            header.classList.add('header-hidden');
        
            document.addEventListener('keydown', function(event) {
                if (event.key.toLowerCase() === 'h') {
                    header.classList.toggle('header-hidden');
                }
            });
        });
        
        // Side menu toggle with 'm' key
        document.addEventListener('DOMContentLoaded', () => {
            const sideMenu = document.querySelector('.side-menu');
            const container = document.querySelector('.container');
            const progressContainer = document.querySelector('.progress-container');
            let isOpen = false;
        
            const toggleSideMenu = () => {
                isOpen = !isOpen;
                if (isOpen) {
                    sideMenu.classList.add('open');
                    container.style.marginRight = '300px'; // Shift content when menu is open
                    progressContainer.style.width = 'calc(100% - 300px)'; // Adjust progress bar
                } else {
                    sideMenu.classList.remove('open');
                    container.style.marginRight = '0'; // Expand content when menu is closed
                    progressContainer.style.width = '100%'; // Full-width progress bar
                }
            };
        
            document.addEventListener('keydown', (e) => {
                if (e.key === 'm' || e.key === 'M') {
                    toggleSideMenu();
                }
            });
        
            // Set initial state
            sideMenu.classList.remove('open');
            container.style.marginRight = '0';
            progressContainer.style.width = '100%';
        });
        
    </script>
</body>
</html>
